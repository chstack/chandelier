/*
 MIT
*/
(function(){var n;n="undefined"!==typeof process&&"nextTick"in process?process.nextTick:function(a){setTimeout(a,0)};var v=function(a){return"object"==typeof a&&null!=a&&a.constructor==Object},t=function(a){return a instanceof Array||"object"===typeof a&&null!=a&&a.constructor==Object},k=function(a){return JSON.parse(JSON.stringify(a))},w=function(a,c){var b=!1;if(1==a.length&&"$any"==a[0]||1==c.length&&"$any"==c[0])return!0;if(a.length==c.length)for(var b=!0,d=0;d<c.length;++d)if("$one"!=a[d]&&"$one"!=
c[d]&&a[d]!=c[d]){b=!1;break}return b},r=function(a){if("/"==a)return["$root"];if("//"==a)return["$any"];a=a.replace(RegExp("[*]","g"),"$one");a=a.split("/");1<a.length&&""==a[0]&&(a[0]="$root");return a},p=function(a){return 1==a.length&&"$root"==a[0]?"/":1==a.length&&"$any"==a[0]?"//":a.join("/").replace(RegExp("[$]one","g"),"*").replace(RegExp("[$]root","g"),"")},C=function(a,c,b){var d=a.middlewares,g=d.length,h=this;(function e(){for(var a=null;;){g--;if(0>g)break;var m=d[g];if(c in m.methods){if("path"in
m)if("path"in b){if(!w(m.path,b.path))continue}else continue;a=m.middleware;break}}if(null!=a)try{a.call(h,b,e,c)}catch(k){console.log("Chandelier middleware threw exception"),console.log(k.stack||"")}})()},D=function(a,c,b,d){var g={};"string"===typeof c&&(c=[c]);if(c instanceof Array){for(var h=0;h<c.length;++h)if("string"===typeof c[h])g[c[h]]=0;else return;if("function"===typeof b)d=b,b=null;else{if("function"!==typeof d)return;b="string"===typeof b?r(b):b}c={middleware:d,methods:g};null!=b&&
(c.path=b);a.middlewares.push(c)}},u=function(a,c,b,d,g,h,f){if(0!=a.length)if(c==a.length)f({parentNode:b,key:d,node:g,path:h});else if(t(g))if("$one"==a[c])for(var e in g)u(a,c+1,g,e,g[e],h.concat(e),f);else a[c]in g&&(b=a[c],u(a,c+1,g,b,g[b],h.concat(b),f))},E=function(){return[Date.now().toString(16),Math.floor(2147483647*Math.random()).toString(16),Math.floor(2147483647*Math.random()).toString(16)].join("_")},x="/*.,()[]|\"'".split(""),y=function(a){if(""==a)return!1;for(var c=0;c<x.length;++c)if(-1<
a.indexOf(x[c]))return!1;return!0},F=function(a,c,b,d,g){b=b[d];d=k(g.message);d.value=k(b);this.emit("created",c,d);if(t(b))for(var h in b)a.recursiveEmitCreated(c.concat(h),b,h,g)},G=function(a,c){var b=c.path,d=c.value,g=c.options,h=c.callback,f=[];u(b,0,{},"",a.data,[],function(a){f.push(a)});if(0<f.length){for(var e,l=0;l<f.length;++l)if(e=f[l],e.node instanceof Array)if("key"in g){var m="number"===typeof g.key?g.key:parseFloat(g.key);if(!isNaN(m)&&0==m%1&&0<=m)e.key=m;else{n(function(){h(Error('Chandelier: the desired key "'+
m+'" is not a non-negative integer at the following container: '+p(e.path)))});return}}else e.key=e.node.length;else if(v(e.node))if("key"in g)if("string"===typeof g.key&&y(g.key)){if(g.key in e.node){n(function(){h(Error('Chandelier: the desired key "'+q+'" is already taken at the following container: '+p(e.path)))});return}e.key=g.key}else{n(function(){h(Error('Chandelier: the desired key "'+q+'" is not a string or contains illegal characters at the following container: '+p(e.path)))});return}else{var q=
this.generateKey();if(y(q)){if(q in e.node){n(function(){h(Error('Chandelier: the generated key "'+q+'" is already taken in the following container: '+p(e.path)))});return}e.key=q}else{n(function(){h(Error('Chandelier: the generated key "'+q+'" contains illegal characters'))});return}}else{n(function(){h(Error("Chandelier: the target node is not a container at the path: "+p(e.path)))});return}for(var z=[],l=0;l<f.length;++l){e=f[l];var r=e.path.concat(e.key),t;e.node instanceof Array?e.node.splice(e.key,
0,d):e.node[e.key]=d;a.recursiveEmitCreated(r,e.node,e.key,g);t=k(g.message);t.value=k(e.node);this.emit("updated",e.path,t);r.toStringPath=p.bind(r,r);z.push({path:r})}n(function(){h(null,z)})}else n(function(){h(Error("Chandelier: there are no elements matching the following path: "+p(b)))})},H=function(a,c,b,d,g){c="string"===typeof c?r(c):c;b=k(b);var h="object"===typeof d?d:{};"message"in h||(h.message={});var f,e;if("function"===typeof d)f=d;else if("function"===typeof g)f=g;else try{e=new this.Promise(function(a,
b){f=function(c,e){c?b(c):a(e)}})}catch(l){f=function(){}}a.callMiddlewares("create",{path:c,value:b,options:h,callback:f});return e},I=function(a,c){var b=c.path,d=c.callback,g=[];u(b,0,{},"",a.data,[],function(a){g.push(a)});if(0<g.length){for(var h=[],f=0;f<g.length;++f){var e=g[f];e.path.toStringPath=p.bind(e.path,e.path);h.push({value:k(e.node),path:e.path})}n(function(){d(null,h)})}else n(function(){d(Error("Chandelier: there are no elements matching the following path: "+p(b)))})},J=function(a,
c,b,d){c="string"===typeof c?r(c):c;var g="object"===typeof b?b:{},h,f;if("function"===typeof b)h=b;else if("function"===typeof d)h=d;else try{f=new this.Promise(function(a,b){h=function(c,d){c?b(c):a(d)}})}catch(e){h=function(){}}a.callMiddlewares("read",{path:c,options:g,callback:h});return f},K=function(a,c,b,d,g,h){var f,e;if(t(b[d]))if(t(g)){f={};var l={},m={};for(e in b[d])f[e]=null;for(e in g)e in f?(delete f[e],m[e]=null):l[e]=null;var q=!1,n;for(e in f)a.recursiveNodeDelete(c.concat(e),b[d],
e,{message:h.message}),q||(n=k(b[d]),q=!0);for(e in l)b[d][e]=g[e],a.recursiveEmitCreated(c.concat(e),b[d],e,{message:h.message}),q||(n=k(b[d]),q=!0);!q&&"forceUpdate"in h&&h.forceUpdate&&(n=k(b[d]),q=!0);q&&(f=k(h.message),f.value=k(g),f.oldValue=n,this.emit("updated",c,f));for(e in m)a.recursiveNodeUpdate(c.concat(e),b[d],e,g[e],h)}else{f=k(h.message);f.value=k(g);f.oldValue=k(b[d]);for(e in b[d])a.recursiveNodeDelete(c.concat(e),b[d],e,{message:h.message});b[d]=g;this.emit("updated",c,f)}else if(t(g)){f=
k(h.message);f.value=k(g);f.oldValue=k(b[d]);b[d]=g;for(e in b[d])a.recursiveEmitCreated(c.concat(e),b[d],e,{message:h.message});this.emit("updated",c,f)}else b[d]==g?"forceUpdate"in h&&h.forceUpdate&&(f=k(h.message),f.value=k(g),f.oldValue=k(b[d]),this.emit("updated",c,f)):(f=k(h.message),f.value=k(g),f.oldValue=k(b[d]),this.emit("updated",c,f),b[d]=g)},L=function(a,c){var b=c.path,d=c.value,g=c.options,h=c.callback,f=[];u(b,0,{},"",a.data,[],function(a){f.push(a)});if(0<f.length){for(var e=[],l=
0;l<f.length;++l){var m=f[l];m.path.toStringPath=p.bind(m.path,m.path);e.push({path:m.path,oldValue:k(m.node)});a.recursiveNodeUpdate(m.path,m.parentNode,m.key,d,g)}n(function(){h(null,e)})}else n(function(){h(Error("Chandelier: there are no elements matching the following path: "+p(b)))})},M=function(a,c,b,d,g){c="string"===typeof c?r(c):c;b=k(b);var h="object"===typeof d?d:{};"message"in h||(h.message={});var f,e;if("function"===typeof d)f=d;else if("function"===typeof g)f=g;else try{e=new this.Promise(function(a,
b){f=function(c,e){c?b(c):a(e)}})}catch(l){f=function(){}}a.callMiddlewares("update",{path:c,value:b,options:h,callback:f});return e},N=function(a,c,b,d,g){var h=k(g.message);h.value=k(b[d]);if(t(b[d]))if(v(b[d]))for(var f in b[d])a.recursiveNodeDelete(c.concat(f),b[d],f,g);else for(f=b[d].length-1;0<=f;--f)a.recursiveNodeDelete(c.concat(f),b[d],f,g);b instanceof Array?(b.splice(d,1),this.emit("deleted",c,h)):v(b)&&(delete b[d],this.emit("deleted",c,h))},O=function(a,c){var b=c.path,d=c.options,g=
c.callback;1==b.length&&"$root"==b[0]&&g(Error("Chandelier: can't delete root"));var h=[];u(b,0,{},"",a.data,[],function(a){h.push(a)});if(0<h.length){for(var f=[],e=0;e<h.length;++e){var l=h[e];l.path.toStringPath=p.bind(l.path,l.path);f.push({value:k(l.node),path:l.path});a.recursiveNodeDelete(l.path,l.parentNode,l.key,d);var m=k(d.message);m.value=k(l.parentNode);this.emit("updated",l.path.slice(0,-1),m)}n(function(){g(null,f)})}else n(function(){g(Error("Chandelier: there are no elements matching the following path: "+
p(b)))})},P=function(a,c,b,d){c="string"===typeof c?r(c):c;var g="object"===typeof b?b:{};"message"in g||(g.message={});var h,f;if("function"===typeof b)h=b;else if("function"===typeof d)h=d;else try{f=new this.Promise(function(a,b){h=function(c,d){c?b(c):a(d)}})}catch(e){h=function(){}}a.callMiddlewares("delete",{path:c,options:g,callback:h});return f},Q=function(a,c,b){c=k(c);c.toStringPath=p.bind(c,c);return{type:a,path:c,message:k(b)}},R=function(a){for(;0<a.emitterQueue.length;){var c=a.emitterQueue.shift();
try{c.listener.callback(c.e)}catch(b){console.log("Chandelier event listener threw exception"),console.log(b.stack||""),console.log("Event:"),console.log(JSON.stringify(c.e,0,4))}}a.emitterInvoked=!1},S=function(a,c,b,d){b="string"===typeof b?r(b):b;for(var g=null,h=!1,f=0;f<a.listeners.length;){var e=a.listeners[f];(c in e.types||"*"in e.types)&&w(e.path,b)?(null==g&&(g=Q(c,b,d)),h=!0,a.emitterQueue.push({listener:e,e:g}),e.once?a.listeners.splice(f,1):++f):++f}h&&!a.emitterInvoked&&(n(function(){a.emitFromQueue()}),
a.emitterInvoked=!0)},A=function(a,c,b,d,g){"string"===typeof b&&(b=[b]);d="string"===typeof d?r(d):d;if("function"===typeof g){for(var h={},f=0;f<b.length;++f)h[b[f]]=null;a.listeners.push({path:d,types:h,callback:g,once:c})}},T=function(a,c){if("function"===typeof c)for(var b=a.listeners.length-1;0<=b;--b)a.listeners[b].callback==c&&a.listeners.splice(b,1)},B=function(a){"undefined"!==typeof a&&v(a);a={};this.toStringPath=p;this.fromStringPath=r;a.middlewares=[];a.callMiddlewares=C.bind(this,a);
this.use=D.bind(this,a);this.generateKey=E;"undefined"!==typeof Promise&&(this.Promise=Promise);a.data={$root:{}};a.recursiveEmitCreated=F.bind(this,a);this.use("create",G.bind(this,a));this.create=H.bind(this,a);this.use("read",I.bind(this,a));this.read=J.bind(this,a);a.recursiveNodeUpdate=K.bind(this,a);this.use("update",L.bind(this,a));this.update=M.bind(this,a);a.recursiveNodeDelete=N.bind(this,a);this.use("delete",O.bind(this,a));this["delete"]=P.bind(this,a);a.listeners=[];a.emitterQueue=[];
a.emitterInvoked=!1;a.emitFromQueue=R.bind(this,a);this.emit=S.bind(this,a);this.on=A.bind(this,a,!1);this.once=A.bind(this,a,!0);this.off=T.bind(this,a)};"undefined"!==typeof window&&(window.Chandelier=B);"undefined"!==typeof module&&(module.exports=B)})();